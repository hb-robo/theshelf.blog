---
// src/components/SpineDisplay.astro
import { getMediaSpec, mmToPx } from '../lib/mediaSpecs';
import fs from 'fs';
import path from 'path';
import type { ExpandedMediaItem } from '../lib/types';
import { getPriorityCreatives } from '../lib/cardElements';
import { formatCreativeLine } from '../lib/cardElements';

export interface Props {
  itemData: ExpandedMediaItem;
}
const { itemData } = Astro.props;

const priorityCreatives = getPriorityCreatives(itemData);
const creativesLine = formatCreativeLine(
  priorityCreatives?.role, priorityCreatives?.names
);

// Get physical specifications
const spec = getMediaSpec(itemData.subtype);

// Calculate dimensions (these will be scaled by CSS variable)
const heightPx = mmToPx(spec.height);
const depthPx = mmToPx(spec.depth);
const topBufferPx = mmToPx(spec.topBuffer);
const bottomBufferPx = mmToPx(spec.bottomBuffer);
const leftBufferPx = spec.leftBuffer ? mmToPx(spec.leftBuffer) : 0;
const rightBufferPx = spec.rightBuffer ? mmToPx(spec.rightBuffer) : 0;

// bright purple default to notice broken logic easily
const colorClass = spec.color || 'bg-purple-400';

const spinePath = itemData.spineImage 
  ? path.join(Astro.site ? '.' : '.', 'public', itemData.spineImage) 
  : null;
const imageExists = spinePath ? fs.existsSync(spinePath) : false;
---

<a 
  href={`/reviews/${itemData.articleSlug}`}
  class="spine-item group block relative"
  style={`
    height: calc(${heightPx}px * var(--shelf-scale));
    width: calc(${depthPx}px * var(--shelf-scale));
    min-width: calc(${depthPx}px * var(--shelf-scale));
  `}
  title={`${itemData.title}${creativesLine ? ` ${creativesLine}` : ''}`}
>
  <!-- Case Structure -->
  <div class="spine-case h-full w-full relative flex flex-col bg-inherit ${spec.topRounding} ${spec.bottomRounding} overflow-hidden`}">
    
    <!-- Top Buffer (clear plastic, etc.) -->
    {spec.topBuffer > 0 && (
      <div 
        class={` ${colorClass} ${spec.topRounding} overflow-hidden`}
        style={`height: calc(${topBufferPx}px * var(--shelf-scale)); min-height: calc(${topBufferPx}px * var(--shelf-scale));`}
      />
    )}
    
    <!-- Spine Content -->
   <div 
      class="spine-content flex-1 relative grid overflow-hidden"
      style={`grid-template-columns: ${
        leftBufferPx > 0 && rightBufferPx > 0
          ? `calc(${leftBufferPx}px * var(--shelf-scale)) minmax(0, 1fr) calc(${rightBufferPx}px * var(--shelf-scale))`
          : leftBufferPx > 0
          ? `calc(${leftBufferPx}px * var(--shelf-scale)) minmax(0, 1fr)`
          : rightBufferPx > 0
          ? `minmax(0, 1fr) calc(${rightBufferPx}px * var(--shelf-scale))`
          : `minmax(0, 1fr)`
      };`}
      >
      <!-- Left Buffer -->
      {leftBufferPx > 0 && (
        <div 
          class={`left-buffer ${colorClass}`}
        />
      )}

      <!-- Middle Content -->
      <div class="relative overflow-hidden w-full h-full">
        <!-- Text spine is always rendered -->
        <div class="absolute inset-0 flex flex-col items-center justify-center p-1 bg-white dark:bg-gray-900 text-black dark:text-white">
          <div class="spine-text transform rotate-90 text-center flex gap-1 items-baseline">
            <span class="font-bold text-s leading-tight mb-1 line-clamp-3 whitespace-nowrap" style="font-size: calc(0.85rem * var(--shelf-scale));">
              {itemData.title}
            </span>
            {creativesLine && (
              <span class="text-gray-600 dark:text-gray-400 text-[0.6rem] line-clamp-2 whitespace-nowrap" style="font-size: calc(0.75rem * var(--shelf-scale));">
                {creativesLine}
              </span>
            )}
          </div>
        </div>

        <!-- Only render image if it exists -->
        {imageExists && (
          <img
            src={itemData.spineImage}
            alt={`${itemData.title} spine`}
            class="absolute inset-0 w-full h-full object-fill"
            loading="lazy"
          />
        )}
      </div>

      <!-- Right Buffer -->
      {rightBufferPx > 0 && (
        <div 
          class={`right-buffer ${colorClass} overflow-hidden`}
        />
      )}
    </div>
    
    <!-- Bottom Buffer -->
    {spec.bottomBuffer > 0 && (
      <div 
        class={`bottom-buffer ${colorClass} ${spec.bottomRounding}`}
        style={`height: calc(${bottomBufferPx}px * var(--shelf-scale)); min-height: calc(${bottomBufferPx}px * var(--shelf-scale));`}
      />
    )}
  </div>

  <!-- Hover overlay with title -->
  <div class={`absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity 
              flex items-center justify-center p-2 pointer-events-none ${spec.topRounding} ${spec.bottomRounding}`}>
    <div class="text-white text-center rotate-90 flex gap-1 items-baseline">
        <span class="font-bold text-xs leading-tight mb-1 whitespace-nowrap" style="font-size: calc(0.85rem * var(--shelf-scale));">
        {itemData.title}
        </span>
        {creativesLine && (
        <span class="text-gray-300 text-[0.6rem] whitespace-nowrap" style="font-size: calc(0.75rem * var(--shelf-scale));">
            {creativesLine}
        </span>
        )}
        <!-- {spec && (
        <span class="text-gray-300 text-[0.6rem] whitespace-nowrap" style="font-size: calc(0.75rem * var(--shelf-scale));">
            ({spec.label})
        </span>
        )} -->
    </div>
  </div>
  
  <!-- Depth shadow effect -->
  <div class={`absolute inset-0 pointer-events-none shadow-md group-hover:shadow-md transition-shadow ${spec.topRounding} ${spec.bottomRounding}`}></div>
</a>

<style>
  .spine-item {
    flex-shrink: 0;
  }
  
  /* Subtle 3D effect */
  .spine-case {
    transform-style: preserve-3d;
  }
  
  /* Better text rendering at small sizes */
  .spine-text {
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
  }
</style>