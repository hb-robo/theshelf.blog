---
// src/components/ReviewCard.astro
import { generateExcerpt } from '../lib/badges';

interface MediaItem {
  title: string;
  releaseDate?: Date;
  madeTheShelf?: boolean;
  result?: 'made-the-shelf' | 'maybe-later' | 'no';
  shelfStatus: 'owned' | 'not-owned' | 'digital-only';
  score?: number;
  mediaType: 'music' | 'game' | 'film' | 'book';
  subtype?: string;
  developer?: string | string[];
  director?: string | string[];
  artist?: string | string[];
  author?: string | string[];
  genre?: string;
  coverImage?: string;
  spineImage?: string;
}

interface Props {
  title: string;
  slug: string;
  date: Date;
  published: boolean;
  heroImage?: string;
  excerpt?: string;
  media?: MediaItem[];
}

const { title, slug, date, published, heroImage, excerpt, media = [] } = Astro.props;

const madeCount = media.filter(m => m.result == "made-the-shelf").length;
const snoozeCount = media.filter(m => m.result == "maybe-later").length;
const totalCount = media.length;
const missedCount = totalCount - madeCount - snoozeCount;

const displayExcerpt = excerpt || generateExcerpt(madeCount, missedCount);
---

<article class="relative border border-gray-200 dark:border-gray-800 rounded-lg overflow-hidden hover:shadow-lg dark:hover:shadow-gray-900/30 transition-shadow"> 
  <div class="flex flex-col md:flex-row">
    <!-- Left side: hero or collage -->
    {heroImage ? (
      <div class="w-full md:w-48 md:min-w-48 flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-900">
        <img 
          src={heroImage} 
          alt={`Cover art for ${title}`}
          class="max-w-full max-h-48 object-contain"
        />
      </div>
    ) : media.length > 0 ? (
      <div class="w-full md:w-48 md:min-w-48 p-2 bg-gray-50 dark:bg-gray-900 grid gap-1">
        {/* First row (always up to 2 items) */}
        <div class="grid grid-cols-2 gap-1 place-items-center">
          {media.slice(0, 2).map((m) => (
            m.coverImage && (
              <img
                src={m.coverImage}
                alt={m.title}
                class={`max-h-48 w-auto object-contain mx-auto ${media.length === 1 ? 'col-span-2' : ''}`}
              />
            )
          ))}
        </div>

        {/* Second row (if there are 3 or 4 items) */}
        {media.length > 2 && (
          <div class={`grid grid-cols-${media.length === 3 ? '1' : '2'} gap-1 place-items-center`}>
            {media.slice(2, 4).map((m) => (
              m.coverImage && (
                <img
                  src={m.coverImage}
                  alt={m.title}
                  class="max-h-24 w-auto object-contain mx-auto"
                />
              )
            ))}
          </div>
        )}
      </div>
    ) : null}

    <!-- Right side: everything that isn't the image -->
    <div class="p-6 flex-1 flex flex-col">
      <div class="flex flex-col md:flex-row gap-4 flex-1">
        <!-- Title and excerpt -->
        <div class="flex-1 flex flex-col gap-2">
          <h3 class="text-xl font-bold">
            <a href={`/reviews/${slug}`} class="hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              {title}
            </a>
          </h3>

          {displayExcerpt && (
            <p class="text-gray-600 dark:text-gray-400 line-clamp-2 text-sm">
              {displayExcerpt}
            </p>
          )}
        </div>
      </div>

      <!-- Badges to indicate total number of reviewed items and their shelf status -->
      {media.length > 0 && (
        <div class="flex flex-wrap gap-1 mt-4">
          {madeCount > 0 && (
            <div class="flex flex-wrap gap-1">
              {Array(madeCount).fill(0).map(() => (
                <span class="w-5 h-5 text-green-600 dark:text-green-300">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-full h-full">
                    <path d="M4 3a1 1 0 0 0-1 1v16a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-4.703L16 20a1 1 0 0 0 1.186.77l3.912-.832a1 1 0 0 0 .77-1.186l-2.91-13.694a1 1 0 0 0-1.186-.77l-2.78.59A1 1 0 0 0 14 4h-4a1 1 0 0 0-1-1zm6 3h3v8h-3zm0 13v-3h3v3zM8 5v10H5V5zm0 12v2H5v-2zm9.332-.35l1.956-.416l.416 1.956l-1.956.416zm-.416-1.957l-1.663-7.825l1.956-.416l1.664 7.826z"/>
                  </svg>
                </span>
              ))}
            </div>
          )}
          {snoozeCount > 0 && (
            <div class="flex flex-wrap gap-1">
              {Array(snoozeCount).fill(0).map(() => (
                <span class="w-5 h-5 text-yellow-500 dark:text-yellow-400">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 32 32" class="w-full h-full">
                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m16.5 17l3 3l-3 3M12 17l3 3l-3 3M5 12h22m-6-4V4M11 8V4M7 28h18a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2"/>
                  </svg>
                </span>
              ))}
            </div>
          )}
          {missedCount > 0 && (
            <div class="flex flex-wrap gap-1">
              {Array(missedCount).fill(0).map(() => (
                <span class="w-5 h-5 text-red-500 dark:text-red-300">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-full h-full">
                    <g fill="currentColor">
                      <path d="M8.478 8.478a1 1 0 0 1 1.414 0l2.154 2.153l2.153-2.153a1 1 0 1 1 1.414 1.414l-2.153 2.154l2.153 2.153a1 1 0 0 1-1.414 1.414l-2.153-2.153l-2.154 2.153A1 1 0 0 1 8.478 14.2l2.153-2.153l-2.153-2.154a1 1 0 0 1 0-1.414"/>
                      <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2M4 12a8 8 0 1 1 16 0a8 8 0 0 1-16 0" clip-rule="evenodd"/>
                    </g>
                  </svg>
                </span>
              ))}
            </div>
          )}
        </div>
      )}

      
      <!-- Footer: pubDate and Read More link -->
      <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-800 mt-4 pt-2">
        <time datetime={date.toISOString()}>
          {date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
        </time>
        <a href={`/reviews/${slug}`} class="hover:text-gray-900 dark:hover:text-gray-100 transition-colors font-medium">
          Read more â†’
        </a>
      </div>
  </div>
</article>
