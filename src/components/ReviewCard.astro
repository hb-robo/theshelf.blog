---
// src/components/ReviewCard.astro
import type { CollectionEntry } from "astro:content";
import {
  generateExcerpt,
  getMediaTitle,
  getMediaCoverImage,
} from "../lib/cardElements.ts";
import MediaPreviewGrid from "./MediaPreviewGrid.astro";

export interface Props {
  itemData: CollectionEntry<"reviews">;
}
const { itemData } = Astro.props;
const { title, date, published, media, heroImage, excerpt } = itemData.data;
const formattedDate = date.toLocaleDateString("fr-CA");

const madeCount = media.filter((m) => m.result == "made-the-shelf").length;
const snoozeCount = media.filter((m) => m.result == "maybe-later").length;
const totalCount = media.length;
const missedCount = totalCount - madeCount - snoozeCount;

const displayExcerpt = excerpt || generateExcerpt(madeCount, missedCount);

const mediaDetailsPromises = media.map(async (mediaItem) => {
  const title = await getMediaTitle(mediaItem.id);
  const coverImage = await getMediaCoverImage(mediaItem.id);

  return {
    ...mediaItem,
    title: title || "Unknown Title",
    coverImage: coverImage || "/placeholder.jpg",
  };
});
const enrichedMediaList = await Promise.all(mediaDetailsPromises);
---

<article
  class="bg-slate-50 dark:bg-slate-800 border-2 border-yellow-800 dark:border-gray-800 rounded-lg overflow-hidden hover:shadow-lg dark:hover:shadow-gray-900/30 transition-shadow"
>
  <div class="flex flex-col md:flex-row max-h-48">
    <!-- Image section: hero or collage -->
    <MediaPreviewGrid
      heroImage={heroImage}
      heroAlt={`Cover art for ${title}`}
      items={enrichedMediaList}
      class="md:w-80 md:min-w-80 md:h-48 bg-amber-100 dark:bg-gray-900 p-2 border-b-2 md:border-b-0 md:border-r-2 border-yellow-800 dark:border-gray-800"
    />
    <!-- Right side: content -->
    <div class="p-5 flex flex-col justify-between w-full">
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-1">
        <div class="flex-1">
          <h3 class="text-xl font-bold mb-1">
            <a
              href={`/reviews/${itemData.slug}`}
              class="hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
            >
              {title}
            </a>
          </h3>

          <p class="text-gray-500 dark:text-gray-500 text-sm mb-2">
            <time datetime={formattedDate}>{formattedDate}</time>
            {media.length > 0 && ` • ${media.length} item${media.length !== 1 ? 's' : ''}`}
          </p>

          {
            displayExcerpt && (
              <p class="text-gray-600 dark:text-gray-400 text-sm line-clamp-2">
                {displayExcerpt}
              </p>
            )
          }
        </div>
      </div>

      <!-- Footer: status icons and read more -->
      <div
        class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-500 mt-4 pt-2"
      >
        {
          media.length > 0 && (
            <div class="flex gap-2">
              {madeCount > 0 && (
                <span class="text-emerald-600 dark:text-emerald-300 inline-flex items-center gap-1">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    class="w-5 h-5"
                  >
                    <path d="M4 3a1 1 0 0 0-1 1v16a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-4.703L16 20a1 1 0 0 0 1.186.77l3.912-.832a1 1 0 0 0 .77-1.186l-2.91-13.694a1 1 0 0 0-1.186-.77l-2.78.59A1 1 0 0 0 14 4h-4a1 1 0 0 0-1-1zm6 3h3v8h-3zm0 13v-3h3v3zM8 5v10H5V5zm0 12v2H5v-2zm9.332-.35l1.956-.416l.416 1.956l-1.956.416zm-.416-1.957l-1.663-7.825l1.956-.416l1.664 7.826z" />
                  </svg>
                  {madeCount}
                </span>
              )}
              {snoozeCount > 0 && (
                <span class="text-yellow-500 dark:text-yellow-400 inline-flex items-center gap-1">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor"
                    viewBox="0 0 32 32"
                    class="w-5 h-5"
                  >
                    <path
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="m16.5 17l3 3l-3 3M12 17l3 3l-3 3M5 12h22m-6-4V4M11 8V4M7 28h18a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2"
                    />
                  </svg>
                  {snoozeCount}
                </span>
              )}
              {missedCount > 0 && (
                <span class="text-red-500 dark:text-red-400 inline-flex items-center gap-1">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    class="w-5 h-5"
                  >
                    <g fill="currentColor">
                      <path d="M8.478 8.478a1 1 0 0 1 1.414 0l2.154 2.153l2.153-2.153a1 1 0 1 1 1.414 1.414l-2.153 2.154l2.153 2.153a1 1 0 0 1-1.414 1.414l-2.153-2.153l-2.154 2.153A1 1 0 0 1 8.478 14.2l2.153-2.153l-2.153-2.154a1 1 0 0 1 0-1.414" />
                      <path
                        fill-rule="evenodd"
                        d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10s10-4.477 10-10S17.523 2 12 2M4 12a8 8 0 1 1 16 0a8 8 0 0 1-16 0"
                        clip-rule="evenodd"
                      />
                    </g>
                  </svg>
                  {missedCount}
                </span>
              )}
            </div>
          )
        }
        <a
          href={`/reviews/${itemData.slug}`}
          class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors text-sm"
        >
          Read review →
        </a>
      </div>
    </div>
  </div>
</article>