---
// src/pages/reviews/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getMediaTypeBadge, getScoreBadge, formatMediaType, getScoreLabel } from '../../lib/badges';

// Get all reviews for static path generation
export async function getStaticPaths() {
  const reviews = await getCollection('reviews');
  return reviews.map((review) => ({
    params: { slug: review.slug },
    props: { review },
  }));
}

const { review } = Astro.props;
const { Content } = await review.render();

// Handle creator field (string or array)
const creatorField = review.data.artist || review.data.developer || review.data.director || review.data.author;
const creator = Array.isArray(creatorField) ? creatorField.join(', ') : creatorField;

// Format date
const formattedDate = review.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout title={`${review.data.title} - Made the Shelf`}>
  <article class="max-w-3xl mx-auto px-4 py-12">
    <!-- Header Section -->
    <header class="mb-12">
      <!-- Breadcrumb -->
      <nav class="text-sm text-gray-600 dark:text-gray-400 mb-6">
        <a href="/" class="hover:text-gray-900 dark:hover:text-gray-100 transition-colors">Home</a>
        <span class="mx-2">/</span>
        <a href="/reviews" class="hover:text-gray-900 dark:hover:text-gray-100 transition-colors">Reviews</a>
        <span class="mx-2">/</span>
        <span>{review.data.title}</span>
      </nav>

      <!-- Media Type & Shelf Status Badges -->
      <div class="flex items-center gap-3 mb-4 flex-wrap">
        <span class={`px-3 py-1 rounded text-sm font-medium ${getMediaTypeBadge(review.data.mediaType)}`}>
          {formatMediaType(review.data.mediaType)}
        </span>
        {review.data.onShelf && (
          <span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 rounded text-sm font-medium">
            ✓ Made the Shelf
          </span>
        )}
        {!review.data.onShelf && (
          <span class="px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 rounded text-sm font-medium">
            ✗ Didn't Make the Shelf
          </span>
        )}
        {review.data.genre && (
          <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded text-sm">
            {review.data.genre}
          </span>
        )}
        {review.data.platform && (
          <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded text-sm">
            {review.data.platform}
          </span>
        )}
      </div>

      <!-- Title & Creator -->
      <h1 class="text-4xl md:text-5xl font-bold mb-3 tracking-tight">
        {review.data.title}
      </h1>
      {creator && (
        <p class="text-xl text-gray-600 dark:text-gray-400 mb-4">
          by {creator}
        </p>
      )}

      <!-- Score & Date -->
      <div class="flex flex-wrap items-center gap-6 text-sm text-gray-600 dark:text-gray-400">
        <div class="flex items-center gap-3">
          <div class={`flex items-center justify-center w-16 h-16 rounded-lg font-bold text-2xl ${getScoreBadge(review.data.score)}`}>
            {review.data.score}
          </div>
          <div>
            <div class="font-semibold text-gray-900 dark:text-gray-100">
              {review.data.score}/10
            </div>
            <div class="text-sm">
              {getScoreLabel(review.data.score)}
            </div>
          </div>
        </div>
        <time datetime={review.data.date.toISOString()}>
          {formattedDate}
        </time>
      </div>
    </header>

    <!-- Cover Image (if exists) -->
    {review.data.coverImage && (
      <div class="mb-12 flex justify-center">
        <div class="max-w-md w-full">
          <img 
            src={review.data.coverImage} 
            alt={`Cover art for ${review.data.title}`}
            class="w-full rounded-lg shadow-lg"
          />
        </div>
      </div>
    )}

    <!-- Review Content -->
    <article class="prose prose-lg dark:prose-invert max-w-none">
      <Content />
    </article>

    <!-- Footer Actions -->
    <footer class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800">
      <div class="flex flex-wrap gap-4 justify-between items-center">
        <a 
          href="/reviews"
          class="px-6 py-3 border border-gray-300 dark:border-gray-700 rounded-lg font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
        >
          ← Back to Reviews
        </a>
        {review.data.onShelf && (
          <a 
            href="/shelf"
            class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors"
          >
            View on Shelf →
          </a>
        )}
      </div>
    </footer>
  </article>
</BaseLayout>