---
// src/pages/shelf.astro
import BaseLayout from '../layouts/BaseLayout.astro';
import SpineDisplay from '../components/SpineDisplay.astro';
import type { ExpandedMediaItem } from '../lib/types.ts';
import { getExpandedMediaList } from '../lib/expandMediaItems.ts';

const allMedia: ExpandedMediaItem[] = await getExpandedMediaList();

const shelfItems = allMedia.filter(
  m => m.published
  && m.result === 'made-the-shelf'
  && m.shelfStatus === 'owned'
);
const wishlistItems = allMedia.filter(
  m => m.published
  && m.result === 'made-the-shelf'
  && m.shelfStatus === 'not-owned'
);
const backlogItems = allMedia.filter(
  m => !m.published
  && m.shelfStatus === 'owned'
)

const totalOnShelf = shelfItems.length;
const approvalRate = allMedia.length > 0 
  ? Math.round((totalOnShelf / allMedia.length) * 100) 
  : 0;
---

<BaseLayout title="The Shelf - Made the Shelf" >
  <div
    class="shelf-container min-h-screen bg-linear-to-b  bg-amber-50 dark:bg-black"
  >
    <!-- Header -->
    <header class="max-w-4xl mx-auto px-4 py-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-2 tracking-tight text-gray-900 dark:text-gray-100">
        digital shelf visualizer
      </h1>
    </header>

    <!-- Main Shelf -->
    <section class="mt-8">
      <div class="max-w-4xl mx-auto px-4 mb-4">
        <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-gray-100">
          The Shelf
          <span class="text-lg font-normal text-gray-600 dark:text-gray-400 ml-2">
            ({totalOnShelf} items)
          </span>
        </h2>
        <p>
          Works that were reviewed and earned their space.
        </p>
      </div>
      <div class="shelf-row w-full bg-gray-50 dark:bg-gray-900 border-y-2 border-gray-300 dark:border-gray-600 shadow-inner overflow-hidden">
        <div
          class="shelf-scroll flex items-end gap-0.5 p-4 overflow-x-auto overflow-y-hidden scroll-smooth"
        >
          {shelfItems
            .sort((a, b) => a.title.localeCompare(b.title))
            .map(item => {
              return (
                <SpineDisplay itemData={item} />
              );
            })}
        </div>
      </div>
    </section>

    {totalOnShelf === 0 && (
      <div class="max-w-4xl mx-auto px-4 text-center py-16">
        <p class="text-xl text-gray-600 dark:text-gray-400">
          The shelf is empty. Nothing has earned its place yet.
        </p>
      </div>
    )}

    <!-- Wishlist Section -->
    <section class="mt-8">
      <div class="max-w-4xl mx-auto px-4 mb-4">
        <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-gray-100">
          The Wishlist
          <span class="text-lg font-normal text-gray-600 dark:text-gray-400 ml-2">
            ({wishlistItems.length} items)
          </span>
        </h2>
        <p>
          Works that earned a spot, but I don't own yet. Physical media prices may keep some items here for long period of time.
        </p>
      </div>
      <div class="shelf-row w-full bg-gray-50 dark:bg-gray-900 border-y-2 border-gray-300 dark:border-gray-600 shadow-inner overflow-hidden">
        <div
          class="shelf-scroll flex items-end gap-0.5 p-4 overflow-x-auto overflow-y-hidden scroll-smooth"
        >
          {wishlistItems
            .sort((a, b) => a.title.localeCompare(b.title))
            .map(item => {
              return (
                <SpineDisplay itemData={item} />
              );
            })}
        </div>
      </div>
    </section>

    <!-- Backlog Section -->
    <section class="mt-8">
      <div class="max-w-4xl mx-auto px-4 mb-4">
        <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-gray-100">
          The Backlog
          <span class="text-lg font-normal text-gray-600 dark:text-gray-400 ml-2">
            ({backlogItems.length} items)
          </span>
        </h2>
        <p>
          Works that I own, but have not written about. Some I have never experienced at all!
        </p>
      </div>
      <div class="shelf-row w-full bg-gray-50 dark:bg-gray-900 border-y-2 border-gray-300 dark:border-gray-600 shadow-inner overflow-hidden">
        <div
          class="shelf-scroll flex items-end gap-0.5 p-4 overflow-x-auto overflow-y-hidden scroll-smooth"
        >
          {backlogItems
            .sort((a, b) => a.title.localeCompare(b.title))
            .map(item => {
              return (
                <SpineDisplay itemData={item} />
              );
            })}
        </div>
      </div>
    </section>


  </div>
</BaseLayout>

<style>
  :root {
    --shelf-scale: 1;
  }

  @media (max-width: 1024px) { :root { --shelf-scale: 0.85; } }
  @media (max-width: 768px)  { :root { --shelf-scale: 0.7; } }
  @media (max-width: 640px)  { :root { --shelf-scale: 0.6; } }


  .shelf-scroll {
    padding-left: max(1rem, calc((100vw - 1280px) / 2 + 1rem + 1rem + 11rem)); /* Align with max-w-4xl + its px-4 */
  }

  .shelf-scroll::-webkit-scrollbar {
    height: 8px;
  }

  .shelf-scroll::-webkit-scrollbar-thumb {
    border-radius: 4px;
  }

  :global(.light) .shelf-scroll::-webkit-scrollbar-thumb {
    background: rgb(156 163 175);
  }

  :global(.dark) .shelf-scroll::-webkit-scrollbar-thumb {
    background: rgb(75 85 99);
  }
</style>
