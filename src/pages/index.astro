---
// src/pages/index.astro
import BaseLayout from '../layouts/BaseLayout.astro';
import ReviewCard from '../components/ReviewCard.astro';
import { getCollection } from 'astro:content';

// Get the 5 most recent reviews
const allReviews = await getCollection('reviews');
const recentReviews = allReviews
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5);


// Live stats
const totalReviews: number = allReviews.length;
var totalMedia: number = 0;
var totalOnShelf: number = 0;
var mediaTypes: string[] = [];
for (const review of allReviews) {
  const media = review.data.media || [];
  totalMedia += media.length;
  totalOnShelf += media.filter(m => m.madeTheShelf).length;
  if (media.length > 0) {
    for(const m of media){
      if(!mediaTypes.includes(m.mediaType)){
        mediaTypes.push(m.mediaType);
      }
    }
  }
}
console.log(mediaTypes);
const totalMediaTypes = mediaTypes.length;
const approvalRate = totalReviews > 0 
  ? Math.round((totalOnShelf / totalMedia) * 100) 
  : 0;
---

<BaseLayout title="Made the Shelf - Media Criticism with a Physical Constraint">
  <!-- Hero Section -->
  <section class="border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950">
    <div class="max-w-4xl mx-auto px-4 py-16 md:py-24">
      <div class="max-w-2xl">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 tracking-tight">
          Made the Shelf
        </h1>
        <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-300 mb-8">
          Writing about creative works with a physical constraint -<br>if it speaks to me, it earns a place on the shelf.
        </p>        
        <!-- <p class="text-xl md:text-lg text-gray-600 dark:text-gray-400 mb-8">
          A personal archive constrained by real shelves and limited space. Albums, games, films, and books that proved worth keeping. 
        </p> -->
        <div class="flex flex-wrap gap-4">
          <a 
            href="/shelf" 
            class="px-6 py-3 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 rounded-lg font-medium hover:opacity-90 transition-opacity"
          >
            View the Shelf
          </a>
          <a 
            href="/reviews" 
            class="px-6 py-3 border border-gray-300 dark:border-gray-700 rounded-lg font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
          >
            Browse Reviews
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats Overview (Optional - shows off the data) -->
  <section class="border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900">
    <div class="max-w-4xl mx-auto px-4 py-12">
      <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100">{totalReviews}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Total Reviews</div>
        </div>
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100">{totalMedia}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Works Covered</div>
        </div>
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100">{totalOnShelf}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Items on Shelf</div>
        </div>
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100">{approvalRate}%</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Made the Cut</div>
        </div>
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100">{totalMediaTypes}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Media Types</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Recent Reviews -->
  <section class="max-w-4xl mx-auto px-4 py-16 bg-white dark:bg-gray-950">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100">Recent Reviews</h2>
      <a 
        href="/reviews" 
        class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors"
      >
        View all â†’
      </a>
    </div>

    <div class="space-y-6">
      {recentReviews.map((review) => (
        <ReviewCard 
          title={review.data.title}
          slug={review.slug}
          published={review.data.published}
          date={review.data.date}
          excerpt={review.data.excerpt}
          heroImage={review.data.heroImage}
          media={review.data.media}
        />
      ))}
    </div>
  </section>

  <!-- Call to Action / About Preview -->
  <section class="border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900">
    <div class="max-w-4xl mx-auto px-4 py-16">
      <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-900 dark:text-gray-100">
          Why the Shelf?
        </h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">
          Physical space is limited. Every item that makes the shelf has earned its place through quality and staying power. This constraint forces honest criticism: would I really want this taking up space in my home?
        </p>
        <a 
          href="/about" 
          class="inline-block px-6 py-3 border border-gray-300dark:text-gray-100 dark:text-gray-100 dark:border-gray-700 rounded-lg font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
        >
          Learn more about the concept
        </a>
      </div>
    </div>
  </section>
</BaseLayout>